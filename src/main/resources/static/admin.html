<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
</head>

<body>
    <h2>Appointments</h2>
    <button id="addAppointmentBtn">Add Appointment</button>
    <ul id="appointmentList"></ul>

    <form class="appointmentModal" id="appointmentModal"
        style="display:none;">
        <h3>Add Appointment</h3>
        <label for="modalCustomerName">Customer Name:</label>
        <input type="text" id="modalCustomerName" required><br><br>

        <label for="modalDogBreed">Dog Breed:</label>
        <input type="text" id="modalDogBreed" required><br><br>

        <label for="modalAppointmentDate">Date:</label>
        <input type="date" id="modalAppointmentDate" required><br><br>

        <label for="modalAppointmentTime">Time:</label>
        <input type="time" id="modalAppointmentTime" required><br><br>

        <label for="modalServices">Services:</label>
        <ul id="modalServicesList" style="list-style-type:none; padding-left:0;"></ul>
        <br>

        <button type="submit" id="modalSubmitBtn">Submit</button>
        <button type="button" id="modalCloseBtn">Cancel</button>
    </form>

    <hr>

    <h2>Services</h2>
    <button id="addServiceBtn">Add Service</button>
    <ul id="serviceList"></ul>

    <script>
        const addAppointmentBtn = document.getElementById('addAppointmentBtn');
        const appointmentModal = document.getElementById('appointmentModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalSubmitBtn = document.getElementById('modalSubmitBtn');
        const modalServicesList = document.getElementById('modalServicesList');

        let editingAppointmentId = null; // Flag for determining if we are doing PUT or POST. Allows reuse of form submission code

        // Show modal on Add Appointment click
        addAppointmentBtn.addEventListener('click', function () {
            appointmentModal.style.display = 'block';
            populateModalServices();
        });

        // Hide modal on Cancel
        modalCloseBtn.addEventListener('click', function () {
            appointmentModal.style.display = 'none';
        });

        // Call addService on Add Service click
        const addServiceBtn = document.getElementById('addServiceBtn');
        addServiceBtn.addEventListener('click', async function () {
            await addService();
        });

        // Fetch services and append as checkboxes
        async function populateModalServices(selectedServices = []) {
            modalServicesList.innerHTML = '';
            try {
                const response = await fetch('http://localhost:8080/services');
                const services = await response.json();
                services.forEach(service => {
                    const li = document.createElement('li');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = service.id;
                    checkbox.id = `service_${service.id}`;
                    checkbox.checked = selectedServices.some(s => s.id === service.id);
                    li.appendChild(checkbox);

                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = `${service.name} ($${service.price})`;
                    li.appendChild(label);

                    modalServicesList.appendChild(li);
                });
            } catch (error) {
                modalServicesList.innerHTML = '<li>Error loading services</li>';
            }
        }

        // Form submission
        appointmentModal.addEventListener('submit', async function (e) {
            e.preventDefault();

            const customerName = document.getElementById('modalCustomerName').value;
            const dogBreed = document.getElementById('modalDogBreed').value;
            const appointmentDate = document.getElementById('modalAppointmentDate').value;
            const appointmentTime = document.getElementById('modalAppointmentTime').value;

            // Get selected service IDs
            const selectedServiceIds = Array.from(modalServicesList.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => parseInt(cb.value));

            const appointment = {
                customerName,
                dogBreed,
                appointmentDate,
                appointmentTime,
                serviceIds: selectedServiceIds
            };

            try {
                if (editingAppointmentId) {
                    await fetch(`http://localhost:8080/appointments/${editingAppointmentId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(appointment)
                    });
                    editingAppointmentId = null;
                } else {
                    await fetch('http://localhost:8080/appointments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(appointment)
                    });
                }
                appointmentModal.style.display = 'none';
                fetchAppointments();
            } catch (error) {
                alert('Error saving appointment');
            }
        });

        // Function to fetch and display appointments
        async function fetchAppointments() {
            try {
                const response = await fetch('http://localhost:8080/appointments');
                const appointments = await response.json();
                const appointmentList = document.getElementById('appointmentList');
                appointmentList.innerHTML = '';

                appointments.forEach(appointment => {
                    // Get a comma-separated string of service names
                    const serviceNames = (appointment.services || [])
                        .map(service => service.name)
                        .join(', ');

                    const li = document.createElement('li');
                    li.textContent = `ID: ${appointment.id}, Customer: ${appointment.customerName}, Dog Breed: ${appointment.dogBreed}, Services: ${serviceNames}, Date: ${appointment.appointmentDate}, Time: ${appointment.appointmentTime}`;

                    // Create Delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.onclick = function () {
                        deleteAppointment(appointment.id);
                    };

                    // Create Edit button
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.onclick = function () {
                        editAppointment(appointment);
                    };

                    li.appendChild(deleteBtn);
                    li.appendChild(editBtn);
                    appointmentList.appendChild(li);
                });
            } catch (error) {
                console.error('Error fetching appointments:', error);
            }
        }

        // Function to delete an appointment given its ID
        async function deleteAppointment(appointmentId) {
            try {
                const response = await fetch(`http://localhost:8080/appointments/${appointmentId}`, {
                    method: 'DELETE'
                });
                // Refresh the list after deletion
                fetchAppointments();
            } catch (error) {
                console.error('Error deleting appointment:', error);
            }
        }

        // Function to edit an appointment
        async function editAppointment(appointment) {
            // Set global editing ID
            editingAppointmentId = appointment.id;

            // Show modal
            appointmentModal.style.display = 'block';

            // Pre-fill fields
            document.getElementById('modalCustomerName').value = appointment.customerName;
            document.getElementById('modalDogBreed').value = appointment.dogBreed;
            document.getElementById('modalAppointmentDate').value = appointment.appointmentDate;
            document.getElementById('modalAppointmentTime').value = appointment.appointmentTime;

            // Populate services and check those that are selected
            await populateModalServices(appointment.services);
        }

        // Function to add a new appointment
        async function addAppointment() {
            const customerName = prompt("Enter customer name:");
            const dogBreed = prompt("Enter dog breed:");
            const serviceId = parseInt(prompt("Enter service ID:"));
            const appointmentDate = prompt("Enter appointment date (YYYY-MM-DD):");
            const appointmentTime = prompt("Enter appointment time (HH:MM):");

            const appointment = {
                customerName: customerName,
                dogBreed: dogBreed,
                serviceId: serviceId,
                appointmentDate: appointmentDate,
                appointmentTime: appointmentTime
            };

            try {
                const response = await fetch('http://localhost:8080/appointments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appointment)
                });
                fetchAppointments(); // Refresh list after adding
            } catch (error) {
                console.error('Error adding appointment:', error);
            }
        }

        // Function to fetch and display services
        async function fetchServices() {
            try {
                const response = await fetch('http://localhost:8080/services');
                const services = await response.json();
                const serviceList = document.getElementById('serviceList');
                serviceList.innerHTML = '';

                services.forEach(service => {
                    const li = document.createElement('li');
                    li.textContent = `ID: ${service.id}, Name: ${service.name}, Price: $${service.price} `;

                    // Create Delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.onclick = function () {
                        deleteService(service.id);
                    };

                    // Create Edit button
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.onclick = function () {
                        editService(service);
                    };

                    li.appendChild(deleteBtn);
                    li.appendChild(editBtn);
                    serviceList.appendChild(li);
                });
            } catch (error) {
                console.error('Error fetching services:', error);
            }
        }

        // Delete a service given its ID
        async function deleteService(serviceId) {
            try {
                const response = await fetch(`http://localhost:8080/services/${serviceId}`, {
                    method: 'DELETE'
                });
                fetchServices(); // Refresh list
            } catch (error) {
                console.error('Error deleting service:', error);
            }
        }

        // Add a new service
        async function addService() {
            const name = prompt("Enter service name:");
            const description = prompt("Enter service description:");
            const price = parseFloat(prompt("Enter service price:"));

            const service = {
                name: name,
                description: description,
                price: price
            };

            try {
                const response = await fetch('http://localhost:8080/services', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(service)
                });
                fetchServices(); // Refresh list
            } catch (error) {
                console.error('Error adding service:', error);
            }
        }

        // Edit a service
        async function editService(service) {
            const newName = prompt("Enter new service name:", service.name);
            const newDescription = prompt("Enter new description:", service.description);
            const newPrice = parseFloat(prompt("Enter new price:", service.price));

            const updatedService = {
                name: newName,
                description: newDescription,
                price: newPrice
            };

            try {
                const response = await fetch(`http://localhost:8080/services/${service.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedService)
                });
                fetchServices(); // Refresh list
            } catch (error) {
                console.error('Error editing service:', error);
            }
        }

        // Initial fetch
        fetchAppointments();
        fetchServices();
    </script>
</body>

</html>